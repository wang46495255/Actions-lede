name: OpenWrt-wang Build & Package Pipeline

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'OpenWrtåˆ†æ”¯'
        required: false
        default: 'master'
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡ (æ ¼å¼: å‹å·)'
        required: false
        default: 'nx30pro'
  repository_dispatch:

permissions:
  contents: write  # æ–°å¢æƒé™å£°æ˜

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: ${{ github.event.inputs.target_branch || 'master' }}
  CONFIG_DIR: config
  TARGET_DEVICE: ${{ github.event.inputs.target_device || 'nx30pro' }}
  TZ: Asia/Shanghai
  UPLOAD_RELEASE: true
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # å¢åŠ è¶…æ—¶æ—¶é—´

    steps:
    # ==================== å…³é”®ä¿®å¤1ï¼šè·¯å¾„æ ‡å‡†åŒ– ====================
    - name: ğŸ”„ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        path: openwrt-config  # æ˜¾å¼æŒ‡å®šæ£€å‡ºè·¯å¾„

    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y --no-install-recommends \
          build-essential ccache cmake git libncurses-dev libssl-dev \
          python3 rsync unzip zlib1g-dev
        sudo mkdir -p /github/workspace/openwrt
        sudo chown -R runner:runner /github/workspace  # ä¿®å¤æƒé™é—®é¢˜

    # ==================== å…³é”®ä¿®å¤2ï¼šå…‹éš†æµç¨‹ä¼˜åŒ– ====================
    - name: ğŸ“¡ å…‹éš†æºç 
      working-directory: /github/workspace
      run: |
        git clone --depth 1 -b "${{ env.REPO_BRANCH }}" "${{ env.REPO_URL }}" openwrt
        [ -d openwrt ] || (echo "::error::æºç å…‹éš†å¤±è´¥"; exit 1)

    # ==================== å…³é”®ä¿®å¤3ï¼šé…ç½®æ–‡ä»¶åŠ è½½ ====================
    - name: âš™ï¸ åŠ è½½é…ç½®
      run: |
        CONFIG_SRC="/github/workspace/${{ env.CONFIG_DIR }}/${{ env.TARGET_DEVICE }}/.config"
        CONFIG_DST="/github/workspace/openwrt/.config"
        [ -f "$CONFIG_SRC" ] && cp -v "$CONFIG_SRC" "$CONFIG_DST" || (echo "::error::é…ç½®æ–‡ä»¶ $CONFIG_SRC ä¸å­˜åœ¨"; exit 1)

    # ==================== ç¼–è¯‘æµç¨‹ä¼˜åŒ– ====================
    - name: ğŸ”„ æ›´æ–°è½¯ä»¶æº
      working-directory: /github/workspace/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ“¦ æ·»åŠ iStoreæº
      working-directory: /github/workspace/openwrt
      run: |
        echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
        ./scripts/feeds update istore
        ./scripts/feeds install -d y -p istore luci-app-store

    - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
      working-directory: /github/workspace/openwrt
      run: |
        make defconfig
        make download -j$(nproc)
        find dl -size -1k -delete  # æ¸…ç†æ— æ•ˆæ–‡ä»¶
        make -j$(($(nproc)+1)) || make -j1 V=s

    # ==================== å‘å¸ƒæµç¨‹ä¼˜åŒ– ====================
    - name: ğŸš€ ç”Ÿæˆå‘å¸ƒåŒ…
      working-directory: /github/workspace/openwrt
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')
        echo "PACKAGE_NAME=openwrt-${DEVICE_NAME}-${TIMESTAMP}.tar.gz" >> $GITHUB_ENV
        tar -czvf ../$PACKAGE_NAME bin/targets/*/*

    - name: ğŸ“¤ å‘å¸ƒç‰ˆæœ¬
      uses: softprops/action-gh-release@v2  # å‡çº§åˆ°v2ç‰ˆæœ¬
      with:
        tag_name: build-${{ env.PACKAGE_NAME }}
        files: /github/workspace/${{ env.PACKAGE_NAME }}
        body: |
          ### ç¼–è¯‘ä¿¡æ¯
          - è®¾å¤‡: ${{ env.TARGET_DEVICE }}
          - æ—¶é—´: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ==================== æ¸…ç†ä¼˜åŒ– ====================
    - name: ğŸ§¹ æ¸…ç†ç¯å¢ƒ
      run: |
        sudo rm -rf /github/workspace/openwrt
        ccache -C  # æ¸…ç†ç¼–è¯‘ç¼“å­˜

    - name: ğŸ“¢ å‘é€é€šçŸ¥
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_COLOR: ${{ job.status == 'success' && '#36a64f' || '#ff0000' }}
        SLACK_MESSAGE: "æ„å»º ${{ job.status }} - è®¾å¤‡ ${{ env.TARGET_DEVICE }}"
