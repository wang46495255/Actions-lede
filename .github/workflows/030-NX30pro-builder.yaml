name: nx30pro 030 builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 5'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: .config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: self-hosted
    container:
      image: wang4649/wang-ubuntu:latest
      options: --user wang
    env:
      HOME: /home/wang
    steps:
      # ------------------------------ åŸæœ‰æ­¥éª¤ä¿æŒä¸å˜ ------------------------------
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main
      
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          ack \
          antlr3 \
          asciidoc \
          autoconf \
          automake \
          autopoint \
          binutils \
          bison \
          build-essential \
          bzip2 \
          ccache \
          clang \
          cmake \
          cpio \
          curl \
          device-tree-compiler \
          flex \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          genisoimage \
          git \
          gperf \
          haveged \
          help2man \
          intltool \
          libc6-dev-i386 \
          libelf-dev \
          libfuse-dev \
          libglib2.0-dev \
          libgmp3-dev \
          libltdl-dev \
          libmpc-dev \
          libmpfr-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libpython3-dev \
          libreadline-dev \
          libssl-dev \
          libtool \
          llvm \
          lrzsz \
          msmtp \
          ninja-build \
          p7zip \
          p7zip-full \
          patch \
          pkgconf \
          python3 \
          python3-pyelftools \
          python3-setuptools \
          qemu-utils \
          rsync \
          scons \
          squashfs-tools \
          subversion \
          swig \
          texinfo \
          uglifyjs \
          upx-ucl \
          unzip \
          vim \
          wget \
          xmlto \
          xxd \
          zlib1g-dev
      
      - name: ä¸‹è½½æºç 
        run: |
          git clone $REPO_URL -b $REPO_BRANCH /home/wang/openwrt
      
      - name: æ›´æ–°FEEDS
        run: |
          cd /home/wang/openwrt && ./scripts/feeds update -a
      
      - name: å®‰è£…FEEDS
        run: cd /home/wang/openwrt && ./scripts/feeds install -a
      
      - name: ä¸‹è½½é…ç½®
        run: |
          [ -e files ] && mv files /home/wang/openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE /home/wang/openwrt/.config
          cd /home/wang/openwrt
          make defconfig
      
      - name: é¢„ä¸‹è½½DL
        run: |
          cd /home/wang/openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd /home/wang/openwrt
          make -j8 || make -j1 V=s
      
      # ------------------------------ æ–°å¢æ­¥éª¤ï¼šæ‰“åŒ…åŒ…å«.binçš„å­ç›®å½• ------------------------------
      - name: æŸ¥æ‰¾å¹¶æ‰“åŒ…åŒ…å«.binæ–‡ä»¶çš„å­ç›®å½•
        run: |
          # å®šä¹‰ç›®æ ‡ç›®å½•ï¼ˆæ ¹æ®å®é™…è·¯å¾„è°ƒæ•´ï¼‰
          BIN_DIR="/home/wang/openwrt/bin"
          
          # æŸ¥æ‰¾æ‰€æœ‰åŒ…å«.binæ–‡ä»¶çš„å­ç›®å½•ï¼ˆå»é‡ï¼‰
          target_dirs=$(find "$BIN_DIR" -type f -name "*.bin" -exec dirname {} \; | sort -u)
          
          if [ -z "$target_dirs" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ…å« .bin æ–‡ä»¶çš„å­ç›®å½•ï¼Œè·³è¿‡æ‰“åŒ…ã€‚"
            exit 0  # æ— æ–‡ä»¶æ—¶ä¸æŠ¥é”™ï¼Œé¿å…ä»»åŠ¡å¤±è´¥
          fi
          
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹åŒ…å« .bin æ–‡ä»¶çš„å­ç›®å½•ï¼š"
          echo "$target_dirs"
          
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„è¾“å‡ºæ–‡ä»¶åï¼ˆé¿å…è¦†ç›–å†å²æ–‡ä»¶ï¼‰
          output_file="/home/wang/openwrt_bins_with_bin_$(date +%Y%m%d%H%M%S).tar.gz"
          
          # åˆ‡æ¢åˆ° BIN_DIR ç›®å½•ï¼Œæ‰“åŒ…å­ç›®å½•ï¼ˆå»é™¤å‰ç½®è·¯å¾„ï¼‰
          tar -czvf "$output_file" -C "$BIN_DIR" $target_dirs
          
          # éªŒè¯æ‰“åŒ…ç»“æœï¼ˆå¯é€‰ï¼‰
          if [ $? -eq 0 ]; then
            echo "ğŸ“¦ æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶è·¯å¾„ï¼š$output_file"
            echo "ğŸ” æ‰“åŒ…å†…å®¹é¢„è§ˆï¼š"
            tar -tvf "$output_file" | head -n 5  # æ˜¾ç¤ºå‰5è¡Œå†…å®¹éªŒè¯
          else
            echo "âŒ æ‰“åŒ…å¤±è´¥ï¼"
            exit 1  # æ‰“åŒ…å¤±è´¥æ—¶ç»ˆæ­¢ä»»åŠ¡
          fi