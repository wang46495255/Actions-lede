name: nx30pro 030 builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 5'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: .config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: self-hosted
    container:
      image: wang4649/wang-ubuntu:latest
      options: --user wang
    env:
      HOME: /home/wang
    steps:
      # ------------------------------ 原有步骤保持不变 ------------------------------
      - name: 检出仓库
        uses: actions/checkout@main
      
      - name: 安装依赖
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          ack \
          antlr3 \
          asciidoc \
          autoconf \
          automake \
          autopoint \
          binutils \
          bison \
          build-essential \
          bzip2 \
          ccache \
          clang \
          cmake \
          cpio \
          curl \
          device-tree-compiler \
          flex \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          genisoimage \
          git \
          gperf \
          haveged \
          help2man \
          intltool \
          libc6-dev-i386 \
          libelf-dev \
          libfuse-dev \
          libglib2.0-dev \
          libgmp3-dev \
          libltdl-dev \
          libmpc-dev \
          libmpfr-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libpython3-dev \
          libreadline-dev \
          libssl-dev \
          libtool \
          llvm \
          lrzsz \
          msmtp \
          ninja-build \
          p7zip \
          p7zip-full \
          patch \
          pkgconf \
          python3 \
          python3-pyelftools \
          python3-setuptools \
          qemu-utils \
          rsync \
          scons \
          squashfs-tools \
          subversion \
          swig \
          texinfo \
          uglifyjs \
          upx-ucl \
          unzip \
          vim \
          wget \
          xmlto \
          xxd \
          zlib1g-dev
      
      - name: 下载源码
        run: |
          git clone $REPO_URL -b $REPO_BRANCH /home/wang/openwrt
      
      - name: 更新FEEDS
        run: |
          cd /home/wang/openwrt && ./scripts/feeds update -a
      
      - name: 安装FEEDS
        run: cd /home/wang/openwrt && ./scripts/feeds install -a
      
      - name: 下载配置
        run: |
          [ -e files ] && mv files /home/wang/openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE /home/wang/openwrt/.config
          cd /home/wang/openwrt
          make defconfig
      
      - name: 预下载DL
        run: |
          cd /home/wang/openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: 编译固件
        run: |
          cd /home/wang/openwrt
          make -j8 || make -j1 V=s
      
      # ------------------------------ 新增步骤：打包包含.bin的子目录 ------------------------------
      - name: 查找并打包包含.bin文件的子目录
        run: |
          # 定义目标目录（根据实际路径调整）
          BIN_DIR="/home/wang/openwrt/bin"
          
          # 查找所有包含.bin文件的子目录（去重）
          target_dirs=$(find "$BIN_DIR" -type f -name "*.bin" -exec dirname {} \; | sort -u)
          
          if [ -z "$target_dirs" ]; then
            echo "⚠️ 未找到包含 .bin 文件的子目录，跳过打包。"
            exit 0  # 无文件时不报错，避免任务失败
          fi
          
          echo "✅ 找到以下包含 .bin 文件的子目录："
          echo "$target_dirs"
          
          # 生成带时间戳的输出文件名（避免覆盖历史文件）
          output_file="/home/wang/openwrt_bins_with_bin_$(date +%Y%m%d%H%M%S).tar.gz"
          
          # 切换到 BIN_DIR 目录，打包子目录（去除前置路径）
          tar -czvf "$output_file" -C "$BIN_DIR" $target_dirs
          
          # 验证打包结果（可选）
          if [ $? -eq 0 ]; then
            echo "📦 打包成功！文件路径：$output_file"
            echo "🔍 打包内容预览："
            tar -tvf "$output_file" | head -n 5  # 显示前5行内容验证
          else
            echo "❌ 打包失败！"
            exit 1  # 打包失败时终止任务
          fi